<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <!-- SEO対策多少はした方がいいのだけど？？ -->
    <meta name="description" content="鳥取の交通をレイヤー表示した地図です" />
    <meta name="keywords" content="鳥取,路線図,バス,日本交通,日ノ丸自動車,バスマップ,バス路線図,busmap" />
    <title>tottori transportation map</title>
    <!-- 表示の為の設定 -->
    <!-- 以下をするとスマホ向けにちょっとだけ描画が改良される -->
    <meta name="viewport" content="width=device-width">
    <!-- //--------------------------------------------- -->
    <!-- ここから最優先CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
    <!-- //--------------------------------------------- -->
    <!-- ここから各プラグイン -->
    <!-- controlLocateプラグイン、現在地表示で使用 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.66.2/dist/L.Control.Locate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.66.2/dist/L.Control.Locate.min.js"
        charset="utf-8"></script>
    <!-- //--------------------------------------------- -->
    <!-- easyボタン アイコンは4.7.0に変更 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <!-- 上のはアイコン使う -->
    <script src="add/leaflet-hash.js"></script>
    <!-- 上のhash.jsは外部プラグイン -->
    <!-- ここから独自 -->
    <link rel="stylesheet" href="add/main.css">
    <style>
        .icon1 {
            width: 30px;
            height: 30px;
            border-radius: 15px;
            border: 3px solid rgb(250, 250, 250);
            box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
            background-color: rgb(204, 51, 166);
        }
    </style>
    <script>
        var map;
        // // 鳥取駅
        const m00 = [35.493795, 134.225827];
        //---------------------------------------------
        // (0.1)アイコン群の設定
        // L.maker(pos,{add})のaddに{icon:i_hn}など
        const i_hn = L.icon({
            iconUrl: 'icons/hn.png',
            iconRetinaUrl: 'icons/hnb.png',
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -50],
        });
        const i_nh = L.icon({
            iconUrl: 'icons/nh.png',
            iconRetinaUrl: 'icons/nhb.png',
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -50],
        });
        const pickIcon = L.divIcon({
            className: 'icon1',
            iconAnchor: [13, 13]
        });
        const loadjson = (addURL) => {
            const baseURL = "./";
            // var data;
            return fetch(baseURL + addURL)
                .then(response => {
                    if (response.ok) {
                        // httpレスポンスからjsonを抽出
                        return response.json();
                    } else {
                        Promise.reject(new Error("error"))
                    }
                })
                .catch(e => {
                    console.log(e.message);
                });
        }
        //---------------------------------------------
        const init = async () => {
            const promiseloadJsons = [
                loadjson("stopinfo/data_11.json"),
                loadjson("stopinfo/data_12.json"),
                loadjson("stopinfo/data_21.json"),
                loadjson("stopinfo/data_22.json")
            ];

            let data11, data12, data21, data22, clipnotes;
            await Promise.all(promiseloadJsons)
                .catch(e => {
                    console.log(e);
                })
                .then(r => {
                    data11 = r[0];
                    data12 = r[1];
                    data21 = r[2];
                    data22 = r[3];
                    clipnotes = r[4];
                });
            map = L.map('map01', {
                zoomControl: false,
                minZoom: 11,
                maxZoom: 17,
            });
            map.setView(m00, 14);
            const base = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
                attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル(淡色)</a>"
            }).addTo(map);
            //---------------------------------------------
            // ローカルバス群
            // (1.1.1)lbm線情報
            const lbm_lines = L.tileLayer('xyz/lbmli/{z}/{x}/{y}.png', {
                tileSize: 256,
                minNativeZoom: 13,
                minZoom: 12,
                maxNativeZoom: 15,
                maxZoom: 17,
                opacity: 0.8,
                errorTileUrl: "icons/noimage.png",
                attribution: "<a href='https://busroutemap.github.io/tottori/index.html' target='_blank'>busroutemap (CC BY 4.0)</a>"
            }).addTo(map);
            //---------------------------------------------
            //(2)バス停位置群
            // lbm_m_in : 上りバス停群
            // lbm_m_out : 下りバス停群
            // (2.1)日ノ丸上り
            // 将来、外国語対応やバス停情報に路線情報をリンクさせる等の場合、
            // conを変えてpass["意訳英語名称"]や<a>路線情報</a>などを検討？
            // vuejsでja/enの瞬殺切り替えとかできれば良いのだけども
            const makeStops = (stops, style) => {
                const markers = stops.values().map(stop => {
                    const position = [
                        stop["緯度"],
                        stop["経度"]
                    ];
                    const pop = L.popup().setContent(
                        stop["上下循環区分"] + '<hr><h2>' + stop["バス停名"] + '</h2>'
                    );
                    return (
                        L.marker(pos, {
                            icon: style
                        }).bindPopup(pop)
                    );
                });
                return markers;
            }
            // 11 日ノ丸上り
            // 12 日ノ丸下り
            // 21 日交上り
            // 22 日交下り
            const l11 = makeStops(data11, i_hn);
            const l12 = makeStops(data12, i_hn);
            const l21 = makeStops(data21, i_nh);
            const l22 = makeStops(data22, i_nh);
            const instops = l11.concat(l21);
            const outstops = l12.concat(l22)
            const lbm_m_in = L.layerGroup(instops);
            const lbm_m_out = L.layerGroup(outstops);
            //---------------------------------------------
            // pickup地点
            // let pickups;
            // let pop = L.popup().setContent(el.name + '<hr><h2><a onclick="map.setView(el.lat,el.lon)">' + この場所を表示する +'</a></h2>');
            //---------------------------------------------
            // pickup絡みはバグが多いので見送り
            // // マーカーが広域表示の場合、自動的に非表示
            // map.on('zoomend', function() {
            // if (map.getZoom() > 12){
            //     // 狭域の場合、pickupsは非表示
            //     map.removeLayer(pickups);
            // } else {
            //     // 広域の場合、自動的にバス停をオフにする
            //     // 広域->狭域時には、うーん、どうしようもない
            //     map.removeLayer(lbm_m_in);
            //     map.removeLayer(lbm_m_out);
            //     // 代わりに主要地をオンにする
            //     map.addLayer(pickups)
            // }
            // });
            //---------------------------------------------
            // (11)注記レイヤー
            const clips = L.geoJSON(clipnotes, {
                    attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院地図</a>にて座標を収集"
                })
                .bindPopup((layer) => {
                    const name = layer.feature.properties.name;
                    const desc = layer.feature.properties.description;
                    const content = `<h3>${name}</h3>${desc}`;
                    return content;
                }).addTo(map);
            //---------------------------------------------
            // (add01)レイヤー表示切替
            const overlays = {
                "<b>(路線バス)</b> 停留所 <上り><br>bus stops < inbound ><hr>": lbm_m_in,
                "<b>(路線バス)</b> 停留所 <下り><br>bus stops < outbound ><hr>": lbm_m_out,
                "<b>(バス・鉄道)</b> 経路・情報<br>routes<hr>": lbm_lines,
            }
            //---------------------------------------------
            //layersコントロールのオーバーレイに設定
            L.control.layers(null, overlays).addTo(map);
            // (add02)ズームボタン
            L.control.zoom({
                position: 'topright'
            }).addTo(map);
            //---------------------------------------------
            // // (add03)EasyButton
            L.easyButton('fa fa-info-circle', function (btn, easyMap) {
                window.open("help/");
            }, '説明書を表示', {
                position: 'topright'
            }).addTo(map);
            //---------------------------------------------
            // (add04)LocateControlプラグイン
            L.control.locate({
                position: 'topright',
                strings: {
                    title: "現在地を表示",
                    popup: "いまここ"
                },
                locateOptions: {
                    maxZoom: 16
                }
            }).addTo(map);
            //---------------------------------------------
            // (add05)表示位置を初期値に戻すボタン
            L.easyButton('fa fa-home', function (btn, easyMap) {
                map.setView(m00, 14);
            }, '表示を初期状態に戻す', {
                position: 'topright'
            }).addTo(map);
            //---------------------------------------------
            // (add99)hashプラグイン
            new L.Hash(map);
            //---------------------------------------------
            // let viewing = true;
            // (開発者向け)背景地図非表示機能
            // let dev = true;
            // if (dev){
            //     L.easyButton('fa fa-eye-slash', function(btn, easyMap){
            //         if (viewing){
            //             base.remove();
            //             viewing = false;
            //         } else {
            //             base.addTo(map);
            //             viewing = true;
            //         }
            //     },'表示を初期状態に戻す', {
            //     position: 'topright'
            //     }).addTo(map);
            // }
            //---------------------------------------------
        }
    </script>
</head>

<body onload="init()">
    <div id="map01"></div>
    <!-- 今後は、地図の初期位置を青谷や用瀬など、場所入れ替えられると良いね -->
</body>

</html>